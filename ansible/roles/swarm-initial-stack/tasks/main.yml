---

- name: Install requirements
  package:
    name: 
      - python3-jsondiff
    state: present

- name: configure initial swarm stack
  become: true
  block:
    - name: place initial_stack.yml file
      template:
        src: initial_stack.yml.j2
        dest: /opt/initial_stack.yml

    - name: Ensure letsencrypt directory exists
      ansible.builtin.file:
        path: /mnt/letsencrypt
        state: directory

    - name: Ensure portainer directory exists
      ansible.builtin.file:
        path: /mnt/portainer
        state: directory

    - name: Ensure mnt has read permissions for filestash
      ansible.builtin.file:
        path: /mnt
        state: directory
        recurse: yes
        mode: '0755'

    - name: Ensure filestash directory exists
      ansible.builtin.file:
        path: /mnt/filestash
        state: directory
        mode: '0777'

    - name: Ensure mariadb directory exists
      ansible.builtin.file:
        path: /mnt/opencms-mysql
        state: directory

    - name: Ensure opencms directory exists
      ansible.builtin.file:
        path: /mnt/opencms-webapps
        state: directory

    - name: Create web network
      docker_network:
        name: web
        driver: "overlay"

    - name: Create local network
      docker_network:
        name: local
        driver: "overlay"

    - name: Deploy stack from the compose file
      community.docker.docker_stack:
        state: present
        name: initial_stack
        compose:
          - /opt/initial_stack.yml

    - name: check port 80 is opened
      wait_for:
        port: "80"
        timeout: 30

    - name: check port 443 is opened
      wait_for:
        port: "443"
        timeout: 30